name: Build and Release

on:
  push:
    tags:
      - 'develop-v*'
      - 'release-v*'

permissions:
  contents: write

jobs:
  version-update:
    name: Sync Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract Version from Tag
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/release-v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/release-v}
            echo "IS_RELEASE=true" >> $GITHUB_ENV
          elif [[ $GITHUB_REF == refs/tags/develop-v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/develop-v}
            echo "IS_RELEASE=false" >> $GITHUB_ENV
          else
            VERSION="0.0.0"
          fi
          echo "Detected version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update Configuration Files
        env:
          VERSION: ${{ steps.get_version.outputs.version }}
        run: |
          # Update package.json
          jq --arg v "$VERSION" '.version = $v' package.json > package.json.tmp && mv package.json.tmp package.json
          
          # Update src-tauri/tauri.conf.json
          jq --arg v "$VERSION" '.version = $v' src-tauri/tauri.conf.json > src-tauri/tauri.conf.json.tmp && mv src-tauri/tauri.conf.json.tmp src-tauri/tauri.conf.json
          
          echo "Updated package.json version:"
          jq '.version' package.json

      - name: Upload Config Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: config-files
          path: |
            package.json
            src-tauri/tauri.conf.json
          retention-days: 1

  build:
    name: Build - ${{ matrix.platform }}-${{ matrix.arch }}
    needs: version-update
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows - x64
          - os: windows-latest
            platform: windows
            arch: x64
            target: x86_64-pc-windows-msvc
          # Linux - x64
          - os: ubuntu-22.04
            platform: linux
            arch: x64
            target: x86_64-unknown-linux-gnu
          # macOS - Intel (x64) - using macos-15-intel (supported until Aug 2027)
          - os: macos-15-intel
            platform: macos
            arch: x64
            target: x86_64-apple-darwin
          # macOS - Apple Silicon (arm64)
          - os: macos-latest
            platform: macos
            arch: arm64
            target: aarch64-apple-darwin

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Config Artifacts
        uses: actions/download-artifact@v4
        with:
          name: config-files
          path: .

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          cache-on-failure: true

      - name: Install Dependencies (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev librsvg2-dev patchelf libsoup-3.0-dev libjavascriptcoregtk-4.1-dev

      - name: Install Frontend Dependencies
        run: npm ci

      - name: Build Tauri App
        run: npm run tauri build -- --target ${{ matrix.target }}

      - name: Rename and Prepare Artifacts
        shell: bash
        env:
          VERSION: ${{ needs.version-update.outputs.version }}
          PLATFORM: ${{ matrix.platform }}
          ARCH: ${{ matrix.arch }}
          TARGET: ${{ matrix.target }}
        run: |
          mkdir -p release-artifacts
          
          # Windows
          if [ "$PLATFORM" == "windows" ]; then
            # NSIS installer (.exe)
            if [ -f "src-tauri/target/$TARGET/release/bundle/nsis/"*.exe ]; then
              cp src-tauri/target/$TARGET/release/bundle/nsis/*.exe "release-artifacts/adbcompass-${VERSION}-windows-${ARCH}-setup.exe" 2>/dev/null || true
            fi
            
            # MSI installer
            if [ -f "src-tauri/target/$TARGET/release/bundle/msi/"*.msi ]; then
              cp src-tauri/target/$TARGET/release/bundle/msi/*.msi "release-artifacts/adbcompass-${VERSION}-windows-${ARCH}.msi" 2>/dev/null || true
            fi
            
            # Portable executable (raw .exe from target/release)
            if [ -f "src-tauri/target/$TARGET/release/"*.exe ]; then
              # Find the main exe (not the uninstaller or other tools)
              for exe in src-tauri/target/$TARGET/release/*.exe; do
                if [[ ! "$exe" == *"uninstall"* ]] && [[ ! "$exe" == *"-"* ]]; then
                  cp "$exe" "release-artifacts/adbcompass-${VERSION}-windows-${ARCH}-portable.exe" 2>/dev/null || true
                  break
                fi
              done
            fi
            
            # Portable ZIP (exe + WebView2Loader.dll if exists)
            mkdir -p portable-temp
            cp "release-artifacts/adbcompass-${VERSION}-windows-${ARCH}-portable.exe" portable-temp/ 2>/dev/null || true
            if [ -f "src-tauri/target/$TARGET/release/WebView2Loader.dll" ]; then
              cp "src-tauri/target/$TARGET/release/WebView2Loader.dll" portable-temp/
            fi
            cd portable-temp
            7z a "../release-artifacts/adbcompass-${VERSION}-windows-${ARCH}-portable.zip" * 2>/dev/null || zip -r "../release-artifacts/adbcompass-${VERSION}-windows-${ARCH}-portable.zip" * 2>/dev/null || true
            cd ..
            rm -rf portable-temp
          
          # Linux
          elif [ "$PLATFORM" == "linux" ]; then
            # AppImage
            cp src-tauri/target/$TARGET/release/bundle/appimage/*.AppImage "release-artifacts/adbcompass-${VERSION}-linux-${ARCH}.AppImage" 2>/dev/null || true
            
            # Deb package
            cp src-tauri/target/$TARGET/release/bundle/deb/*.deb "release-artifacts/adbcompass-${VERSION}-linux-${ARCH}.deb" 2>/dev/null || true
          
          # macOS
          elif [ "$PLATFORM" == "macos" ]; then
            cp src-tauri/target/$TARGET/release/bundle/dmg/*.dmg "release-artifacts/adbcompass-${VERSION}-macos-${ARCH}.dmg" 2>/dev/null || true
          fi
          
          echo "Artifacts prepared:"
          ls -la release-artifacts/

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.platform }}-${{ matrix.arch }}
          path: release-artifacts/*
          retention-days: 7
          if-no-files-found: warn

  create-release:
    name: Create Release
    needs: [version-update, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: artifacts-*
          merge-multiple: true

      - name: Display Artifacts
        run: |
          echo "All artifacts:"
          ls -laR artifacts/

      - name: Determine Release Type
        id: release_type
        run: |
          if [[ "${{ github.ref }}" == refs/tags/release-v* ]]; then
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "release_name=ADB Compass ${{ needs.version-update.outputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "release_name=Development Build ${{ needs.version-update.outputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.release_type.outputs.release_name }}
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: ${{ steps.release_type.outputs.is_prerelease }}
          files: artifacts/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


