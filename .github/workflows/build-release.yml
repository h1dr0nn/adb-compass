name: Build and Release

on:
  push:
    tags:
      - 'develop-v*'
      - 'release-v*'

permissions:
  contents: write

jobs:
  build:
    name: Build - ${{ matrix.platform }}-${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows - x64
          - os: windows-latest
            platform: windows
            arch: x64
            target: x86_64-pc-windows-msvc
          # Linux - x64
          - os: ubuntu-22.04
            platform: linux
            arch: x64
            target: x86_64-unknown-linux-gnu
          # macOS - Intel (x64) - using macos-15-intel (supported until Aug 2027)
          - os: macos-15-intel
            platform: macos
            arch: x64
            target: x86_64-apple-darwin
          # macOS - Apple Silicon (arm64)
          - os: macos-latest
            platform: macos
            arch: arm64
            target: aarch64-apple-darwin

    outputs:
      version: ${{ steps.get_version.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract Version from Tag
        id: get_version
        shell: bash
        run: |
          if [[ $GITHUB_REF == refs/tags/release-v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/release-v}
          elif [[ $GITHUB_REF == refs/tags/develop-v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/develop-v}
          else
            VERSION="0.0.0"
          fi
          echo "Detected version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update Configuration Files
        shell: bash
        env:
          VERSION: ${{ steps.get_version.outputs.version }}
        run: |
          # Update package.json
          if command -v jq &> /dev/null; then
            jq --arg v "$VERSION" '.version = $v' package.json > package.json.tmp && mv package.json.tmp package.json
            jq --arg v "$VERSION" '.version = $v' src-tauri/tauri.conf.json > src-tauri/tauri.conf.json.tmp && mv src-tauri/tauri.conf.json.tmp src-tauri/tauri.conf.json
          else
            # Fallback for systems without jq - use node
            node -e "const fs=require('fs'); const p=JSON.parse(fs.readFileSync('package.json')); p.version='$VERSION'; fs.writeFileSync('package.json', JSON.stringify(p, null, 2));"
            node -e "const fs=require('fs'); const p=JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json')); p.version='$VERSION'; fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(p, null, 2));"
          fi
          
          echo "Updated versions to: $VERSION"
          cat package.json | grep version || true
          cat src-tauri/tauri.conf.json | grep version || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          cache-on-failure: true

      - name: Install Dependencies (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev librsvg2-dev patchelf libsoup-3.0-dev libjavascriptcoregtk-4.1-dev

      - name: Install Frontend Dependencies
        run: npm ci

      - name: Build Tauri App
        run: npm run tauri build -- --target ${{ matrix.target }}

      - name: Rename and Prepare Artifacts
        shell: bash
        env:
          VERSION: ${{ needs.version-update.outputs.version }}
          PLATFORM: ${{ matrix.platform }}
          ARCH: ${{ matrix.arch }}
          TARGET: ${{ matrix.target }}
        run: |
          mkdir -p release-artifacts
          
          # Windows
          if [ "$PLATFORM" == "windows" ]; then
            # Debug: List all files in release folder
            echo "=== Files in target/$TARGET/release/ ==="
            ls -la "src-tauri/target/$TARGET/release/" || true
            echo "=== Files in bundle/nsis/ ==="
            ls -la "src-tauri/target/$TARGET/release/bundle/nsis/" 2>/dev/null || true
            echo "=== Files in bundle/msi/ ==="
            ls -la "src-tauri/target/$TARGET/release/bundle/msi/" 2>/dev/null || true
            
            # NSIS installer (.exe)
            cp src-tauri/target/$TARGET/release/bundle/nsis/*.exe "release-artifacts/adbcompass-${VERSION}-windows-${ARCH}-setup.exe" 2>/dev/null || true
            
            # MSI installer
            cp src-tauri/target/$TARGET/release/bundle/msi/*.msi "release-artifacts/adbcompass-${VERSION}-windows-${ARCH}.msi" 2>/dev/null || true
            
            # Portable executable - the main app exe (ADB Compass.exe or similar)
            # Find exe that matches the app name (without spaces it could be adb-compass.exe or similar)
            PORTABLE_EXE=""
            for exe in "src-tauri/target/$TARGET/release/ADB Compass.exe" \
                       "src-tauri/target/$TARGET/release/adb-compass.exe" \
                       "src-tauri/target/$TARGET/release/adbcompass.exe" \
                       "src-tauri/target/$TARGET/release/ADB-Compass.exe"; do
              if [ -f "$exe" ]; then
                PORTABLE_EXE="$exe"
                break
              fi
            done
            
            if [ -n "$PORTABLE_EXE" ]; then
              cp "$PORTABLE_EXE" "release-artifacts/adbcompass-${VERSION}-windows-${ARCH}-portable.exe"
              echo "Found portable exe: $PORTABLE_EXE"
            else
              echo "WARNING: Could not find portable exe!"
              # Fallback: find any .exe that's not a dll or installer-related
              ls -la "src-tauri/target/$TARGET/release/"*.exe 2>/dev/null || true
            fi
          
          # Linux
          elif [ "$PLATFORM" == "linux" ]; then
            # AppImage
            cp src-tauri/target/$TARGET/release/bundle/appimage/*.AppImage "release-artifacts/adbcompass-${VERSION}-linux-${ARCH}.AppImage" 2>/dev/null || true
            
            # Deb package
            cp src-tauri/target/$TARGET/release/bundle/deb/*.deb "release-artifacts/adbcompass-${VERSION}-linux-${ARCH}.deb" 2>/dev/null || true
          
          # macOS
          elif [ "$PLATFORM" == "macos" ]; then
            cp src-tauri/target/$TARGET/release/bundle/dmg/*.dmg "release-artifacts/adbcompass-${VERSION}-macos-${ARCH}.dmg" 2>/dev/null || true
          fi
          
          echo "Artifacts prepared:"
          ls -la release-artifacts/

      - name: Create Windows Portable ZIP
        if: matrix.platform == 'windows'
        shell: pwsh
        env:
          VERSION: ${{ steps.get_version.outputs.version }}
          ARCH: ${{ matrix.arch }}
        run: |
          $portableExe = "release-artifacts/adbcompass-${env:VERSION}-windows-${env:ARCH}-portable.exe"
          $zipFile = "release-artifacts/adbcompass-${env:VERSION}-windows-${env:ARCH}-portable.zip"
          
          if (Test-Path $portableExe) {
            # Create temp folder and copy files
            New-Item -ItemType Directory -Force -Path "portable-temp" | Out-Null
            Copy-Item $portableExe -Destination "portable-temp/adbcompass.exe"
            
            # Check for WebView2Loader.dll
            $webviewDll = "src-tauri/target/${{ matrix.target }}/release/WebView2Loader.dll"
            if (Test-Path $webviewDll) {
              Copy-Item $webviewDll -Destination "portable-temp/"
            }
            
            # Create ZIP
            Compress-Archive -Path "portable-temp/*" -DestinationPath $zipFile -Force
            Remove-Item -Recurse -Force "portable-temp"
            
            Write-Host "Created portable ZIP: $zipFile"
          } else {
            Write-Host "WARNING: Portable exe not found, skipping ZIP creation"
          }

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.platform }}-${{ matrix.arch }}
          path: release-artifacts/*
          retention-days: 7
          if-no-files-found: warn

  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Extract Version from Tag
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/release-v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/release-v}
          elif [[ $GITHUB_REF == refs/tags/develop-v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/develop-v}
          else
            VERSION="0.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: artifacts-*
          merge-multiple: true

      - name: Display Artifacts
        run: |
          echo "All artifacts:"
          ls -laR artifacts/

      - name: Determine Release Type
        id: release_type
        run: |
          if [[ "${{ github.ref }}" == refs/tags/release-v* ]]; then
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "release_name=ADB Compass ${{ steps.get_version.outputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "release_name=Development Build ${{ steps.get_version.outputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.release_type.outputs.release_name }}
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: ${{ steps.release_type.outputs.is_prerelease }}
          files: artifacts/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
